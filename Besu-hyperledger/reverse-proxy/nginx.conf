worker_processes  1;

events {
    worker_connections 1024;
}

http {
    # Basic security/TLS hardening
    ssl_protocols             TLSv1.3;
    ssl_prefer_server_ciphers on;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream gui_upstream {
        server host.docker.internal:3000;
    }

    upstream ethsigner_upstream {
        server ethsignerProxy:8545;
    }

    upstream ksm_upstream {
        server ksm-service:8080;
    }

    upstream zkp_upstream {
        server host.docker.internal:8081;
    }

    server {
        listen              443 ssl;
        server_name         revproxy.interbank.local localhost;

        ssl_certificate      /etc/nginx/tls/revproxy-chain.crt;
        ssl_certificate_key  /etc/nginx/tls/revproxy.key;
        ssl_trusted_certificate /etc/nginx/tls/revproxy-chain.crt;

        # GUI (Next.js)
        location /gui/ {
            proxy_pass http://gui_upstream/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # EthSigner
        location /ethsigner/ {
            proxy_pass http://ethsigner_upstream/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # KSM service
        location /ksm/ {
        proxy_pass http://ksm_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ZKP Prover (running on host:8081)
        location /zkp/ {
            proxy_pass http://zkp_upstream/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}

